#!/usr/bin/env python
#
# Copyright (C) 2012  Leo Singer
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
from __future__ import division
"""
Create a template bank that has a single template that exactly matches
the first sim_inspiral record in an injection file.
"""
__author__ = "Leo Singer <leo.singer@ligo.org>"


# Command line interface.
from optparse import Option, OptionParser
from bayestar_localization import command

parser = OptionParser(
    formatter = command.NewlinePreservingHelpFormatter(),
    description = __doc__,
    usage="%prog [INPUT.xml[.gz]] [-o OUTPUT.xml[.gz]]",
    option_list = [
        Option("-o", "--output", metavar="OUTPUT.xml[.gz]", default="/dev/stdout",
            help="Name of output file (default=stdout)")
    ]
)
opts, args = parser.parse_args()

# Determine if input will come from a named file or from stdin.
if len(args) == 0:
    infilename = '/dev/stdin'
elif len(args) == 1:
    infilename = args[0]
else:
    raise ValueError("Too many command line arguments.")


# Python standard library imports.
import os

# LIGO-LW XML imports.
from glue.ligolw import ligolw
from pylal import llwapp as ligolw_app
from glue.ligolw.utils import process as ligolw_process
from glue.ligolw import table as ligolw_table
from pylal import ligolw_thinca
from glue.ligolw import utils as ligolw_utils
from glue.ligolw import lsctables

# glue, LAL and pylal imports.
from glue import lal
import swiglal, swiglalsimulation

# BAYESTAR imports.
from bayestar_localization import misc

# Other imports.
import numpy as np


# Open output file.
out_xmldoc = ligolw.Document()
out_xmldoc.appendChild(ligolw.LIGO_LW())

# Write process metadata to output file.
process = ligolw_process.register_to_xmldoc(out_xmldoc, parser.get_prog_name(),
    opts.__dict__, ifos="H1", comment="Exact-match template bank")

# Read injection file.
xmldoc = ligolw_utils.load_filename(infilename)

# Extract simulation table from injection file.
sim_inspiral_table = ligolw_table.get_table(xmldoc,
    lsctables.SimInspiralTable.tableName)

# Extract first entry from simulation table.
sim_inspiral = sim_inspiral_table[0]

# Create a SnglInspiral table and initialize its row ID counter.
sngl_inspiral_table = lsctables.New(lsctables.SnglInspiralTable)
out_xmldoc.childNodes[0].appendChild(sngl_inspiral_table)
sngl_inspiral_table.set_next_id(lsctables.SnglInspiralID(0))

sngl_inspiral = lsctables.SnglInspiral()
for validcolumn in sngl_inspiral_table.validcolumns.iterkeys():
	setattr(sngl_inspiral, validcolumn, None)
sngl_inspiral.event_id = sngl_inspiral_table.get_next_id()
sngl_inspiral.mass1 = sim_inspiral.mass1
sngl_inspiral.mass2 = sim_inspiral.mass2
sngl_inspiral.mtotal = sngl_inspiral.mass1 + sngl_inspiral.mass2
sngl_inspiral.mchirp = sim_inspiral.mchirp
sngl_inspiral.eta = sim_inspiral.eta
sngl_inspiral.ifo = "H1"
sngl_inspiral.f_final = misc.get_f_lso(sngl_inspiral.mass1, sngl_inspiral.mass2)
sngl_inspiral_table.append(sngl_inspiral)

# Record process end time.
ligolw_process.set_process_end_time(process)

# Write output file.
ligolw_utils.write_filename(out_xmldoc, opts.output,
    gz=(os.path.splitext(opts.output)[-1]==".gz"))
